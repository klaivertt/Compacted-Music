<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Watch2Gether</title>
    <link rel="stylesheet" href="Styles.css">
</head>

<body>
    <!-- Background Image -->
    <div class="background"></div>

    <!-- Header -->
    <header>
        <button class="login-btn-appleMusic">Login with Apple Music</button>
        <button class="login-btn-spotify" id="login">Login with Spotify</button>
        <script>
            const clientId = '08f32674306a4d289b71abb8915cf9d1';
            const redirectUri = 'http://127.0.0.1:5500/callback.html';
            const scopes = [
                'user-read-private',
                'user-read-email',
                'user-read-playback-state',
                'user-modify-playback-state'
            ];

            document.getElementById('login').addEventListener('click', () => {
                const authUrl = `https://accounts.spotify.com/authorize?response_type=token&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes.join(' '))}`;
                window.location.href = authUrl;
            });
        </script>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Now Playing Section -->
        <div class="now-playing">
            <img src="https://is1-ssl.mzstatic.com/image/thumb/Music125/v4/5c/0e/66/5c0e66c0-d383-5641-3ec0-4bdb629c49ad/886445705119.jpg/300x300bb.webp"
                alt="Album Cover">
            <div class="controls">
                <button onclick="prevTrack()">⏮️</button>
                <button onclick="togglePlay()">⏯️</button>
                <button onclick="nextTrack()">⏭️</button>
            </div>
            <div class="progress">
                <div class="progress-bar">
                    <div style="width: 50%;"></div>
                </div>
                <div class="time">1:30 / 3:00</div>
            </div>
            <h2>Now Playing</h2>
            <p id="now-playing-text">No track playing</p>
        </div>

        <!-- Queue Section -->
        <div class="queue">
            <h2>Queue</h2>
            <ul id="queue-list">
                <li>No songs in the queue</li>
            </ul>
        </div>

        <!-- Add Music Section -->
        <div class="add-music">
            <input type="text" id="search-input" placeholder="Search for a song or artist">
            <button id="search-btn">Search</button>
            <div id="search-results"></div>
        </div>
    </div>

    <script>
        const nowPlayingImg = document.querySelector('.now-playing img');
        const nowPlayingText = document.getElementById('now-playing-text');
        const background = document.querySelector('.background');
        const queueList = document.getElementById('queue-list');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-btn');
        const searchResultsContainer = document.getElementById('search-results');
        let accessToken = localStorage.getItem('spotifyAccessToken'); // Get the token from localStorage
        let currentTrackIndex = 0; // To keep track of the current song in the queue
        let tracksQueue = []; // Array to store the queue of tracks

        // Function to sync background image with "Now Playing" album cover
        function syncBackgroundWithNowPlaying(imgSrc) {
            background.style.backgroundImage = `url(${imgSrc})`;
        }

        // Function to search for songs on Spotify
        async function searchMusic(query) {
            if (!accessToken) {
                alert('Please log in to Spotify first!');
                return;
            }

            try {
                const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=5`, {
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    }
                });

                const data = await response.json();
                const tracks = data.tracks.items;

                // Clear previous results
                searchResultsContainer.innerHTML = '';

                // Display new results
                tracks.forEach(track => {
                    const trackElement = document.createElement('div');
                    trackElement.classList.add('track-result');
                    trackElement.innerHTML = `
                        <img src="${track.album.images[2]?.url}" alt="${track.name}" width="50" height="50">
                        <p>${track.name} by ${track.artists.map(artist => artist.name).join(', ')}</p>
                        <button onclick="addToQueue('${track.id}', '${track.name}', '${track.album.images[2]?.url}')">Add to Queue</button>
                    `;
                    searchResultsContainer.appendChild(trackElement);
                });
            } catch (error) {
                console.error('Error searching music:', error);
            }
        }

        // Function to add a track to the queue
        function addToQueue(trackId, trackName, trackImage) {
            tracksQueue.push({ trackId, trackName, trackImage });
            updateQueueUI();
            if (tracksQueue.length === 1) {
                playTrack(0);
            }
        }

        // Update the queue UI
        function updateQueueUI() {
            queueList.innerHTML = '';
            if (tracksQueue.length === 0) {
                queueList.innerHTML = '<li>No songs in the queue</li>';
                nowPlayingText.textContent = 'No track playing';
                nowPlayingImg.src = '';
                syncBackgroundWithNowPlaying('');
            } else {
                tracksQueue.forEach((track, index) => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('queue-item');
                    listItem.innerHTML = `
                        <img src="${track.trackImage}" alt="${track.trackName}" width="50" height="50">
                        <p>${track.trackName}</p>
                        <button onclick="removeFromQueue(${index})">Remove</button>
                    `;
                    queueList.appendChild(listItem);
                });
            }
        }

        // Remove track from the queue
        function removeFromQueue(index) {
            tracksQueue.splice(index, 1);
            updateQueueUI();
            if (index === currentTrackIndex && tracksQueue.length > 0) {
                playTrack(0); // Start playing the first track in the queue
            }
        }

        // Function to play a track
        async function playTrack(index) {
            const track = tracksQueue[index];
            currentTrackIndex = index;
            nowPlayingText.textContent = `Now playing: ${track.trackName}`;
            nowPlayingImg.src = track.trackImage;
            syncBackgroundWithNowPlaying(track.trackImage);

            // Call Spotify API to start playback
            try {
                const response = await fetch('https://api.spotify.com/v1/me/player/play', {
                    method: 'PUT',
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uris: [`spotify:track:${track.trackId}`]
                    })
                });
                if (!response.ok) {
                    console.error('Failed to play track');
                }
            } catch (error) {
                console.error('Error playing track:', error);
            }
        }

        // Control playback (play/pause)
        function togglePlay() {
            fetch('https://api.spotify.com/v1/me/player/play', {
                method: 'PUT',
                headers: {
                    Authorization: `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                }
            });
        }

        // Play next track
        function nextTrack() {
            if (currentTrackIndex < tracksQueue.length - 1) {
                playTrack(currentTrackIndex + 1);
            }
        }

        // Play previous track
        function prevTrack() {
            if (currentTrackIndex > 0) {
                playTrack(currentTrackIndex - 1);
            }
        }

        // Event listener for search button
        searchButton.addEventListener('click', () => {
            const query = searchInput.value;
            if (query) {
                searchMusic(query);
            }
        });

        // Event listener for enter key to search
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const query = searchInput.value;
                if (query) {
                    searchMusic(query);
                }
            }
        });

        // Initial setup if queue is not empty
        if (tracksQueue.length > 0) {
            playTrack(0);
        }

    </script>
</body>

</html>
